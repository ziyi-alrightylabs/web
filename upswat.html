<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Delivery Capture</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background: #f2f2f2;
      }
      .container {
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .card-header {
        background-color: #007bff;
        color: #fff;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        text-align: center;
        font-size: 1.25rem;
      }
      .preview-img {
        width: 100px;
        height: auto;
        margin: 5px;
        border-radius: 5px;
        object-fit: cover;
        border: 2px solid #ddd;
      }
      #signatureCanvas {
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 5px;
        width: 100%;
        height: 250px;
      }
    </style>
    <!-- Signature Pad Library -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="card-header">Delivery Capture</div>
        <div class="card-body">
          <!-- Referral Info -->
          <div id="referralInfo" class="mb-3"></div>

          <!-- Photo Upload Section -->
          <div class="mb-4">
            <h5>Upload Photos (up to 3)</h5>
            <input
              type="file"
              id="photoInput"
              accept="image/*"
              multiple
              class="form-control"
            />
            <div id="photoPreview" class="d-flex flex-wrap mt-3"></div>
          </div>

          <!-- Geolocation Section -->
          <div class="mb-4">
            <h5>Your Location</h5>
            <button id="locationButton" class="btn btn-primary mb-2">
              Get Location
            </button>
            <p id="locationDisplay" class="form-control-plaintext">
              Location not captured yet.
            </p>
          </div>

          <!-- Signature Section -->
          <div class="mb-4">
            <h5>Signature</h5>
            <canvas id="signatureCanvas"></canvas>
            <button id="clearSignature" class="btn btn-secondary btn-sm mt-2">
              Clear Signature
            </button>
          </div>

          <!-- Submit Button -->
          <div class="text-center">
            <button id="submitButton" class="btn btn-success">Complete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Utility: Parse URL query parameters
      function getQueryParams() {
        let params = {};
        let queryString = window.location.search.substring(1);
        let regex = /([^&=]+)=([^&]*)/g;
        let m;
        while ((m = regex.exec(queryString))) {
          params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
        }
        return params;
      }

      // Display referral info (mobile, project, stop, etc.)
      const params = getQueryParams();
      const referralInfoDiv = document.getElementById("referralInfo");
      if (Object.keys(params).length > 0) {
        referralInfoDiv.innerHTML = `
          <p><strong>Referral Info:</strong></p>
          <p>Mobile: ${params.mobile || "N/A"}</p>
          <p>Project: ${params.project || "N/A"}</p>
          <p>Stop: ${params.stop || "N/A"}</p>
        `;
      }

      // Photo Upload Handling
      const photoInput = document.getElementById("photoInput");
      const photoPreviewDiv = document.getElementById("photoPreview");
      photoInput.addEventListener("change", function () {
        photoPreviewDiv.innerHTML = "";
        const files = photoInput.files;
        if (files.length > 3) {
          alert("You can upload up to 3 photos only.");
          photoInput.value = ""; // Reset file input if too many files selected
          return;
        }
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.className = "preview-img";
            photoPreviewDiv.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });

      // Geolocation Handling
      const locationButton = document.getElementById("locationButton");
      const locationDisplay = document.getElementById("locationDisplay");
      let capturedLocation = null;
      locationButton.addEventListener("click", function () {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              capturedLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
              };
              locationDisplay.innerText =
                "Lat: " +
                capturedLocation.latitude.toFixed(5) +
                ", Lon: " +
                capturedLocation.longitude.toFixed(5);
            },
            function (error) {
              alert("Error getting location: " + error.message);
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      });

      // Signature Pad Setup
      const canvas = document.getElementById("signatureCanvas");
      const signaturePad = new SignaturePad(canvas);

      // Resize canvas for high-DPI devices
      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear(); // Ensure the pad is cleared after resizing
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      // Clear signature on button click
      const clearButton = document.getElementById("clearSignature");
      clearButton.addEventListener("click", function () {
        signaturePad.clear();
      });

      // Submission Handling
      const submitButton = document.getElementById("submitButton");
      submitButton.addEventListener("click", function () {
        // Validate inputs; allow user to override if desired
        if (photoInput.files.length === 0) {
          if (!confirm("No photos uploaded. Proceed anyway?")) {
            return;
          }
        }
        if (!capturedLocation) {
          if (!confirm("Location not captured. Proceed without location?")) {
            return;
          }
        }
        if (signaturePad.isEmpty()) {
          if (!confirm("Signature is empty. Proceed without a signature?")) {
            return;
          }
        }

        // Assemble all data into a FormData object
        const formData = new FormData();
        // Append referral parameters from URL
        for (const key in params) {
          formData.append(key, params[key]);
        }
        // Append photo files
        for (let i = 0; i < photoInput.files.length; i++) {
          formData.append("photo" + (i + 1), photoInput.files[i]);
        }
        // Append geolocation data if available
        if (capturedLocation) {
          formData.append("latitude", capturedLocation.latitude);
          formData.append("longitude", capturedLocation.longitude);
        }
        // Append signature image as data URL if not empty
        if (!signaturePad.isEmpty()) {
          const signatureDataUrl = signaturePad.toDataURL();
          formData.append("signature", signatureDataUrl);
        }

        // For demonstration purposes, we'll log the formData entries.
        // Replace the following with your backend submission code.
        alert("Submission is being processed. Check console for details.");
        for (let pair of formData.entries()) {
          console.log(pair[0] + ": ", pair[1]);
        }

        // Example submission (replace URL with your backend endpoint):
        // fetch('https://yourdomain.com/api/submitDelivery', {
        //   method: 'POST',
        //   body: formData
        // })
        // .then(response => response.json())
        // .then(data => {
        //   alert("Submission successful!");
        // })
        // .catch(error => {
        //   console.error("Error submitting data:", error);
        //   alert("Submission failed. Please try again.");
        // });
      });
    </script>
  </body>
</html>

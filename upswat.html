<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Delivery Capture</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap"
      rel="stylesheet"
    />
    <!-- Signature Pad Library -->
    <script
      src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"
      defer
    ></script>

    <style>
      /* =======================
         Base & Typography
      ========================= */
      body {
        font-family: "Roboto", sans-serif;
        /* Subtle gradient background moving from white to a light peach hue */
        background: linear-gradient(180deg, #ffffff 0%, #fcefe9 100%);
        margin: 0;
        padding: 0;
      }

      .container {
        margin-top: 20px;
        margin-bottom: 20px;
      }

      /* =======================
         Card & Layout
      ========================= */
      .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* Update the header background to match the client’s primary orange color */
      .card-header {
        background-color: #f95c1c; /* Adjust if you have a different hex code */
        color: #fff;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        text-align: center;
        font-size: 1.25rem;
      }

      /* =======================
         Buttons & Colors
      ========================= */
      /* Custom button class to replace default Bootstrap colors with brand color */
      .btn-brand {
        background-color: #f95c1c; /* Primary brand color */
        border-color: #f95c1c;
        color: #fff;
      }
      .btn-brand:hover,
      .btn-brand:focus {
        background-color: #e04c14; /* Darken slightly on hover */
        border-color: #e04c14;
        color: #fff;
      }

      /* Secondary button style for “Clear Signature” or neutral actions */
      .btn-secondary-custom {
        background-color: #e5e5e5;
        border-color: #dcdcdc;
        color: #333;
      }
      .btn-secondary-custom:hover,
      .btn-secondary-custom:focus {
        background-color: #dcdcdc;
        border-color: #cccccc;
        color: #333;
      }

      /* =======================
         Photo Preview & Canvas
      ========================= */
      .preview-img {
        width: 100px;
        height: auto;
        margin: 5px;
        border-radius: 5px;
        object-fit: cover;
        border: 2px solid #ddd;
      }

      #signatureCanvas {
        background-color: #ffffff;
        border: 1px solid #ced4da;
        border-radius: 5px;
        width: 100%;
        height: 250px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="card-header">Delivery Capture</div>
        <div class="card-body">
          <!-- Referral Info -->
          <div id="referralInfo" class="mb-3"></div>

          <!-- Photo Upload Section -->
          <div class="mb-4">
            <h5>Upload Photos (up to 3)</h5>
            <input
              type="file"
              id="photoInput"
              accept="image/*"
              multiple
              class="form-control"
            />
            <div id="photoPreview" class="d-flex flex-wrap mt-3"></div>
          </div>

          <!-- Geolocation Section -->
          <div class="mb-4">
            <h5>Your Location</h5>
            <button id="locationButton" class="btn btn-brand mb-2">
              Get Location
            </button>
            <p id="locationDisplay" class="form-control-plaintext">
              Location not captured yet.
            </p>
          </div>

          <!-- Signature Section -->
          <div class="mb-4">
            <h5>Signature</h5>
            <canvas id="signatureCanvas"></canvas>
            <button id="clearSignature" class="btn btn-secondary-custom btn-sm mt-2">
              Clear Signature
            </button>
          </div>

          <!-- Submit Button -->
          <div class="text-center">
            <button id="submitButton" class="btn btn-brand">
              Complete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>

    <script>
      // =============================
      // 1. Query Parameter Parsing
      // =============================
      function getQueryParams() {
        let params = {};
        let queryString = window.location.search.substring(1);
        let regex = /([^&=]+)=([^&]*)/g;
        let m;
        while ((m = regex.exec(queryString))) {
          params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
        }
        return params;
      }

      const params = getQueryParams();
      const referralInfoDiv = document.getElementById("referralInfo");
      if (Object.keys(params).length > 0) {
        referralInfoDiv.innerHTML = `
          <p><strong>Referral Info:</strong></p>
          <p>Mobile: ${params.mobile || "N/A"}</p>
          <p>Project: ${params.project || "N/A"}</p>
          <p>Stop: ${params.stop || "N/A"}</p>
        `;
      }

      // =============================
      // 2. Photo Upload Handling
      // =============================
      const photoInput = document.getElementById("photoInput");
      const photoPreviewDiv = document.getElementById("photoPreview");

      photoInput.addEventListener("change", function () {
        photoPreviewDiv.innerHTML = "";
        const files = photoInput.files;

        if (files.length > 3) {
          alert("You can upload up to 3 photos only.");
          photoInput.value = ""; // Reset file input
          return;
        }

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.className = "preview-img";
            photoPreviewDiv.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });

      // =============================
      // 3. Geolocation Handling
      // =============================
      const locationButton = document.getElementById("locationButton");
      const locationDisplay = document.getElementById("locationDisplay");
      let capturedLocation = null;

      locationButton.addEventListener("click", function () {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              capturedLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
              };
              locationDisplay.innerText =
                "Lat: " +
                capturedLocation.latitude.toFixed(5) +
                ", Lon: " +
                capturedLocation.longitude.toFixed(5);
            },
            function (error) {
              alert("Error getting location: " + error.message);
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      });

      // =============================
      // 4. Signature Pad Setup
      // =============================
      const canvas = document.getElementById("signatureCanvas");
      const signaturePad = new SignaturePad(canvas);

      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      const clearButton = document.getElementById("clearSignature");
      clearButton.addEventListener("click", function () {
        signaturePad.clear();
      });

      // =============================
      // 5. Submission Handling
      // =============================
      const submitButton = document.getElementById("submitButton");
      submitButton.addEventListener("click", async function () {
  // Validate inputs
  if (photoInput.files.length === 0) {
    if (!confirm("No photos uploaded. Proceed anyway?")) return;
  }
  if (!capturedLocation) {
    if (!confirm("Location not captured. Proceed without location?")) return;
  }
  if (signaturePad.isEmpty()) {
    if (!confirm("Signature is empty. Proceed without a signature?")) return;
  }

  // Assemble all data into FormData
  const formData = new FormData();

  // Include query params
  for (const key in params) {
    formData.append(key, params[key]);
  }

  // Photo files
  for (let i = 0; i < photoInput.files.length; i++) {
    formData.append("photo" + (i + 1), photoInput.files[i]);
  }

  // Location
  if (capturedLocation) {
    formData.append("latitude", capturedLocation.latitude);
    formData.append("longitude", capturedLocation.longitude);
  }

  // Signature as image blob (not base64 string)
  if (!signaturePad.isEmpty()) {
    const dataURL = signaturePad.toDataURL("image/png");
    const blob = dataURLtoBlob(dataURL);
    formData.append("signature", blob, "signature.png");
  }

  // Disable button during submission
  submitButton.disabled = true;
  submitButton.innerText = "Submitting...";

  try {
    const response = await fetch("https://goswat.onrender.com/api/submitDelivery", {
      method: "POST",
      body: formData,
    });

    if (!response.ok) throw new Error("Server returned " + response.status);

    const result = await response.json();
    console.log("✅ Success:", result);
    alert("✅ Submission successful!");
  } catch (error) {
    console.error("❌ Submission error:", error);
    alert("❌ Submission failed: " + error.message);
  } finally {
    submitButton.disabled = false;
    submitButton.innerText = "Complete";
  }
});

// Helper to convert dataURL to Blob
function dataURLtoBlob(dataURL) {
  const parts = dataURL.split(",");
  const mime = parts[0].match(/:(.*?);/)[1];
  const bstr = atob(parts[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) {
    u8arr[n] = bstr.charCodeAt(n);
  }
  return new Blob([u8arr], { type: mime });
}
    </script>
  </body>
</html>
